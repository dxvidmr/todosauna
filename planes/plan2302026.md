# Plan Maestro por Fases: Participación Unificada + Testimonios + Aporte Documental

## Resumen
- Objetivo: pasar de un sistema centrado en `evaluaciones` (lectura/laboratorio) a una infraestructura completa de participación con sesiones globales, perfiles pseudoanónimos, testimonios, aportes documentales y vínculo entre ambos.
- Estado actual verificado: hoy existen `sesiones`, `colaboradores`, `evaluaciones`, `notas`, `pasajes`, `notas_activas` en `supabase/migrations/20260223172700_baseline_public.sql`; no existen tablas de testimonios/documentos/vínculos; la sesión no se crea al abrir web; el modal se usa antes de contribuir en lectura/laboratorio; no hay formularios de envío en `/participa`.
- Decisiones ya cerradas contigo e incorporadas: rutas de envío en `/participa/*`, seguridad de subida con token firmado + reCAPTCHA, rate limiting por sesión+IP hash, GeoNames obligatorio día 1, y todas las decisiones previas sobre consentimiento/privacidad/estado/modo de sesión.

## Cambios clave en APIs/interfaces/tipos públicos
- Se añaden tablas públicas nuevas: `testimonios`, `contribuciones_archivo`, `vinculos_testimonio_archivo`, `contribuciones_upload_staging`, `participacion_rate_limit_events`.
- Se amplían tablas existentes: `sesiones` y `colaboradores`.
- Se introducen RPC v2 para sesión/modo/registro vinculado/envíos y enlace testimonio-documento.
- Se mantiene compatibilidad temporal con RPC legacy (`rpc_create_session`, `rpc_collaborator_*`) durante transición; se deprecán al final.
- Se añaden Edge Functions para token de subida, finalización/cancelación y limpieza de huérfanos.
- Se añade contrato JSON de privacidad de testimonio (`privacy_settings`).
- Se oficializan rutas de envío:
  - `/participa/testimonios/enviar/`
  - `/participa/documentos/enviar/`
- Se mantienen rutas de exploración:
  - `/archivo/testimonios/`
  - `/archivo/documentos/`

## Plan por fases (ejecutable en varios días)

### Fase 0: Preparación y control de riesgo
1. Congelar baseline y crear rama de trabajo de migraciones.
2. Verificar estado CLI enlazado y historial remoto/local (`migration list`) antes de tocar esquema.
3. Definir matriz de secretos y variables:
   - Frontend público: `SUPABASE_URL`, `SUPABASE_PUBLISHABLE_KEY`, `GEONAMES_USERNAME`, `RECAPTCHA_SITE_KEY`.
   - Backend privado (Edge/CI): `SUPABASE_SERVICE_ROLE_KEY`, `RECAPTCHA_SECRET`, `UPLOAD_TOKEN_SECRET`, `APPS_SCRIPT_URL`, `APPS_SCRIPT_SHARED_SECRET`.
4. Resultado esperado: entorno listo para migrar sin reintroducir el fallo de `db pull`.

### Fase 1: Migración de modelo base (sesiones + perfiles)
1. Crear migración SQL `*_01_sessions_profiles_refactor.sql`.
2. En `sesiones` añadir:
   - `browser_session_token uuid unique not null`
   - `modo_participacion text null check (in ('anonimo','colaborador'))`
   - `modal_lectura_post_first_shown boolean not null default false`
   - `last_activity_at timestamptz not null default now()`
   - quitar datos demográficos de usuarios anónimos: ahora anónimo es puro y solo colaboradore registrará más cosas
3. En `colaboradores` añadir:
   - `año_nacimiento smallint`
   - `city_name text`, `city_geoname_id bigint`
   - `country_name text`, `country_geoname_id bigint`
   - `relacion_obra text[]` (array de opciones en desplegable + otro libre, en el mismo array)
   - `consent_rgpd boolean not null default false`
   - `consent_rgpd_version text`, `consent_accepted_at timestamptz`
   - `updated_at timestamptz not null default now()`
4. Añadir checks e índices para búsquedas por hash/email, geoname y modo.
5. No romper `evaluaciones` ni FKs existentes.

### Fase 2: Nuevas tablas de participación (testimonios/documentos/vínculos)
1. Crear migración SQL `*_02_participacion_archivo_schema.sql`.
2. Crear `testimonios` con:
   - FK a `sesiones`, FK opcional a `colaboradores`
   - `titulo text`, `testimonio text` (permite Markdown)
   - Campos contextuales, todos opcionales:
       - `experiencia_fecha date` y `experiencia_fecha_texto text` (alternativos)
       - `experiencia_ciudad_nombre text`, `experiencia_ciudad_geoname_id bigint`
       - `experiencia_pais_nombre text`, `experiencia_pais_geoname_id bigint`
       - `experiencia_lugar_texto text` (libre, para lugares no indexados en GeoNames)
       - `experiencia_contexto text` CHECK ('personal','academico','profesional','otro')
       - `experiencia_rango_edad text` CHECK ('menos_de_18','18_25','26_35','36_50','51_65','mas_de_65')
   - `relacion_obra text[]` (valores enum + texto libre del usuario en el mismo array)
   - `linked_archive_refs text[]` (enlaces o IDs de objetos del archivo)
   - `privacy_settings jsonb not null`
   - Consentimiento de envío obligatorio:
       `privacy_consent boolean not null`,
       `privacy_consent_version text not null`,
       `privacy_consent_at timestamptz not null`
   - `status text not null default 'nuevo' check (nuevo/aprobado/rechazado)`
   - `publicado boolean not null default false`
   - `archivo_objeto_id text null`
3. Crear `contribuciones_archivo` con:
   - FK a `sesiones`, FK opcional a `colaboradores`
   - Metadatos:
       `titulo text not null`
       `descripcion text`
       `creadores jsonb` (array de objetos {nombre, rol}; número variable)
       `fecha date` y `fecha_texto text` (alternativos, para fecha exacta o aproximada)
       `lugar_nombre text`, `lugar_geoname_id bigint` (GeoNames)
       `lugar_texto text` (libre, para lugares no indexados en GeoNames)
   - Vínculos a objetos ya existentes en el archivo:
       `linked_archive_refs text[]` (enlaces o IDs de objetos del archivo)
   - Derechos declarados sobre los archivos enviados:
       `rights_type text not null` CHECK ('cc_by_nc_sa','copyright')
       `rights_holder text` (obligatorio si rights_type = 'copyright', null si CC)
   - `drive_file_ids text[] not null` (IDs de Drive; mínimo 1 elemento al insertar)
   - `status text not null default 'nuevo'` CHECK ('nuevo','aprobado','rechazado')
   - `collectionbuilder_id text null` (se rellena manualmente al publicar en el archivo)
   - Consentimiento de envío obligatorio:
       `privacy_consent boolean not null`
       `privacy_consent_version text not null`
       `privacy_consent_at timestamptz not null`
4. Crear `vinculos_testimonio_archivo` (N:M) con unique `(testimonio_id, contribucion_id)` y `declared_from`.
5. Crear `contribuciones_upload_staging` para controlar subidas no finalizadas y limpieza.

### Fase 3: RPC v2 + RLS + hardening
1. Crear migración SQL `*_03_rpc_v2_rls.sql` con funciones:
   - `rpc_bootstrap_session`
   - `rpc_set_mode_anonimo`
   - `rpc_collaborator_register_and_bind_session`
   - `rpc_collaborator_login_and_bind_session`
   - `rpc_submit_testimonio`
   - `rpc_submit_contribucion_archivo`
   - `rpc_link_testimonio_contribucion`
   - `rpc_list_testimonios_publicos`
2. Añadir helper de IP hash desde headers de request y tabla `participacion_rate_limit_events`.
3. Aplicar rate limits en RPC de envío (sesión + IP hash).
4. RLS:
   - tablas internas sin insert/select directo para `anon`/`authenticated`.
   - sólo ejecución de RPC.
   - exposición pública únicamente por vista/RPC de testimonios aprobados y publicados.
5. Mantener RPC legacy temporalmente para no romper frontend actual hasta que migre.

### Fase 4: Capa frontend compartida de sesión y modo
1. Crear capa JS compartida en `assets/js/participacion/`:
   - `session-manager.js`
   - `supabase-api-v2.js`
   - `modal-participacion.js`
   - `geonames-autocomplete.js`
2. Implementar sesión automática al abrir web:
   - bootstrap en layouts globales (`_layouts/default.html` y `_layouts/laboratorio.html`).
   - usar `browser_session_token` persistido como cookie de sesión de navegador (no permanente).
3. Refactor de modal:
   - soportar contextos: lectura post-primera contribución, laboratorio pre-juego, formularios pre-acceso.
   - registro/login vinculan la misma sesión existente (no crean sesión nueva).
4. Dejar `assets/js/lectura/user-manager.js` y `assets/js/lectura/modal-modo.js` como wrappers temporales para transición controlada.

### Fase 5: Ajuste de lectura y laboratorio al nuevo flujo
1. Lectura (`assets/js/lectura/sala-de-lectura-evaluacion.js`, `assets/js/lectura/sugerencias-notas.js`):
   - permitir primera contribución anónima sin bloquear por modal.
   - tras primer envío exitoso, mostrar modal una sola vez.
2. Laboratorio (`assets/js/lectura/laboratorio-de-notas.js`):
   - no mostrar modal al cargar página.
   - mostrar modal al elegir modo de juego, antes de iniciar interacción.
3. “Mi participación” sigue funcionando con estado de sesión unificado.

### Fase 6: Formularios nuevos en `/participa/*`
1. Crear páginas:
   - `pages/participa-testimonios-enviar.md` (`/participa/testimonios/enviar/`)
   - `pages/participa-documentos-enviar.md` (`/participa/documentos/enviar/`)
2. Actualizar CTAs y navegación:
   - `pages/participa.md`
   - `_includes/navbar.html`
3. Implementar formulario Testimonios:
   - título + markdown
   - campos contextuales opcionales
   - privacidad JSON
   - consentimiento obligatorio de envío
   - propuesta de “añadir documento vinculado” post-submit
4. Implementar formulario Aporte documental (2 pasos):
   - paso 1 metadatos/derechos
   - paso 2 subida Drive + obtención IDs + confirmación
   - cancelación borra subidas (best effort inmediato + cleanup diferido garantizado)
   - propuesta de “añadir testimonio vinculado” post-submit
5. GeoNames obligatorio día 1 en ciudad/país de perfil y campos de lugar contextual.

### Fase 7: Pipeline seguro de subida a Google Drive
1. Crear Edge Functions:
   - `issue-upload-token`
   - `finalize-document-upload`
   - `cancel-document-upload`
   - `cleanup-stale-uploads` (programada)
2. Apps Script:
   - endpoints `upload` y `delete` con verificación de token firmado.
   - restricciones MIME/tamaño/número de archivos.
3. Validar reCAPTCHA antes de emitir token de subida.
4. Registrar trazabilidad en `contribuciones_upload_staging`.

### Fase 8: Moderación, publicación y limpieza legacy
1. Moderación:
   - testimonios: `status` + `publicado`
   - contribuciones: `status`
2. Crear vista pública de testimonios para `/archivo/testimonios/` desde Supabase en vivo.
3. Limpiar/deprecar:
   - rutas/funciones legacy de sesión tras validación completa.
   - código duplicado en `assets/js/lectura/*` sustituido por capa compartida.
4. Documentar operación:
   - guía de migraciones
   - guía de rotación de secretos
   - guía de moderación y flujo manual hacia CollectionBuilder.

## Casos de prueba y escenarios de validación

1. Sesión global:
   - abrir cualquier URL del sitio crea/recupera sesión.
   - misma sesión en pestañas del mismo navegador durante la sesión activa.
2. Lectura:
   - primera contribución anónima se guarda.
   - modal aparece después, una sola vez, y no bloquea la contribución ya hecha.
3. Laboratorio:
   - modal aparece al elegir modo (no al cargar).
   - al registrar/login, la sesión actual se vincula sin perder historial.
4. Testimonios:
   - envío anónimo y envío colaborador.
   - consentimiento de envío obligatorio.
   - privacidad JSON aplicada en salida pública.
5. Aporte documental:
   - subida con token válido + recaptcha.
   - cancelación elimina archivos.
   - cierre inesperado recuperado por limpieza programada.
6. Vínculos:
   - enlace desde testimonio a documento y viceversa.
   - relación N:M sin duplicados.
7. Seguridad:
   - sin INSERT directo por `anon` en tablas sensibles.
   - rate limit activo por sesión+IP hash.
   - sólo vistas/RPC públicos exponen datos publicados.
8. Regresión:
   - `/lectura/` sigue leyendo XML estático si Supabase falla.
   - `/participa/laboratorio/` sigue operativo con Supabase disponible.
9. Migraciones:
   - `supabase db reset` local limpio.
   - `supabase db pull` sin error de shadow database.
   - `supabase migration up` idempotente en entorno de staging.

## Supuestos y defaults explícitos
- Modelo único de sesión: una sesión por navegador activo, no por página.
- `status` estándar para envíos: `nuevo`, `aprobado`, `rechazado`.
- Testimonios visibles sólo con `status='aprobado'` y `publicado=true`.
- Consentimientos separados:
  - consentimiento de perfil en `colaboradores` (cuando hay registro).
  - consentimiento por envío en cada formulario.
- GeoNames obligatorio desde el primer release funcional.
- Se mantiene Drive como almacenamiento binario; Supabase sólo guarda metadatos e IDs.
- Límite inicial recomendado de abuso:
  - testimonios: 3/24h por sesión, 10/24h por IP hash.
  - contribuciones: 2/24h por sesión, 8/24h por IP hash.
- No se elimina RPC legacy hasta cerrar validación funcional y de datos en producción.

## Backlog de refactor tecnico

| id | area | deuda | impacto | riesgo | fase objetivo | estado | criterio de cierre |
| --- | --- | --- | --- | --- | --- | --- | --- |
| RF-001 | JS arquitectura | Migrar de IIFE global a ES Modules cuando se retire `legacy-bridge.js`. | Alto | Medio | Fase 8 | pendiente | Los scripts de participacion se cargan como modulos sin `window.*` compartido. |
| RF-002 | JS legacy | Eliminar `assets/js/lectura/user-manager.js` y `assets/js/lectura/modal-modo.js` (shims). | Medio | Bajo | Fase 8 | pendiente | No quedan referencias a estos archivos en includes/layouts ni en runtime. |
| RF-003 | UI modal | Separar plantilla HTML del modal en parcial/template y dejar JS solo con logica. | Medio | Bajo | Fase 6 | pendiente | El render del modal no contiene HTML inline largo en JS. |
| RF-004 | Manejo errores | Unificar toasts/errores de RPC con codigos normalizados por capa. | Alto | Medio | Fase 6 | pendiente | Errores de participacion muestran mensajes consistentes por codigo. |
| RF-005 | QA automatizada | Anadir pruebas automatizadas para bootstrap, bind de sesion y reset a `unasked`. | Alto | Medio | Fase 7 | pendiente | Flujo session/mode/bind cubierto en test automatizado reproducible. |
| RF-006 | Configuracion | Consolidar configuracion Supabase en unica fuente y retirar fallback legacy duplicado. | Medio | Bajo | Fase 8 | pendiente | `SUPABASE_CONFIG` se define en un unico archivo sin shims de compatibilidad. |
