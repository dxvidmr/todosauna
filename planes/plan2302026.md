# Plan Maestro por Fases: ParticipaciÃ³n Unificada + Testimonios + Aporte Documental

## Estado de ejecuciÃ³n (actualizado 2026-02-27)
- Fases 0 a 7: implementadas/avanzadas.
- Desde Fase 8, el roadmap activo se divide y continÃºa en `planes/replanv2.md`.
- F10.1 completada (QA base E2E local + CI smoke).
- F10.2 completada (telemetria minima de embudo lectura).
- F11.1 completada (retirada legacy segura sin borrado fisico).
- F11.2 completada (borrado fisico legacy + corte total de compatibilidad).
- Orden de ejecucion vigente: `8.2 -> 12`.

## Resumen
- Objetivo: pasar de un sistema centrado en `evaluaciones` (lectura/laboratorio) a una infraestructura completa de participacin con sesiones globales, perfiles pseudoannimos, testimonios, aportes documentales y vnculo entre ambos.
- Estado actual verificado: hoy existen `sesiones`, `colaboradores`, `evaluaciones`, `notas`, `pasajes`, `notas_activas` en `supabase/migrations/20260223172700_baseline_public.sql`; no existen tablas de testimonios/documentos/vnculos; la sesin no se crea al abrir web; el modal se usa antes de contribuir en lectura/laboratorio; no hay formularios de envo en `/participa`.
- Decisiones ya cerradas contigo e incorporadas: rutas de envo en `/participa/*`, seguridad de subida con token firmado + reCAPTCHA, rate limiting por sesin+IP hash, GeoNames obligatorio da 1, y todas las decisiones previas sobre consentimiento/privacidad/estado/modo de sesin.

## Cambios clave en APIs/interfaces/tipos pblicos
- Se aaden tablas pblicas nuevas: `testimonios`, `contribuciones_archivo`, `vinculos_testimonio_archivo`, `contribuciones_upload_staging`, `participacion_rate_limit_events`, `participacion_funnel_events`.
- Se amplan tablas existentes: `sesiones` y `colaboradores`.
- Se introducen RPC v2 para sesin/modo/registro vinculado/envos y enlace testimonio-documento.
- Se mantiene compatibilidad temporal con RPC legacy (`rpc_create_session`, `rpc_collaborator_*`) durante transicin; se deprecn al final.
- Se aaden Edge Functions para token de subida, finalizacin/cancelacin y limpieza de hurfanos.
- Se aade contrato JSON de privacidad de testimonio (`privacy_settings`).
- Se oficializan rutas de envo:
  - `/participa/testimonios/enviar/`
  - `/participa/documentos/enviar/`
- Se mantienen rutas de exploracin:
  - `/archivo/testimonios/`
  - `/archivo/documentos/`

## Plan por fases (ejecutable en varios das)

### Fase 0: Preparacin y control de riesgo
1. Congelar baseline y crear rama de trabajo de migraciones.
2. Verificar estado CLI enlazado y historial remoto/local (`migration list`) antes de tocar esquema.
3. Definir matriz de secretos y variables:
   - Frontend pblico: `SUPABASE_URL`, `SUPABASE_PUBLISHABLE_KEY`, `GEONAMES_USERNAME`, `RECAPTCHA_SITE_KEY`.
   - Backend privado (Edge/CI): `SUPABASE_SERVICE_ROLE_KEY`, `RECAPTCHA_SECRET`, `UPLOAD_TOKEN_SECRET`, `APPS_SCRIPT_URL`, `APPS_SCRIPT_SHARED_SECRET`.
4. Resultado esperado: entorno listo para migrar sin reintroducir el fallo de `db pull`.

### Fase 1: Migracin de modelo base (sesiones + perfiles)
1. Crear migracin SQL `*_01_sessions_profiles_refactor.sql`.
2. En `sesiones` aadir:
   - `browser_session_token uuid unique not null`
   - `modo_participacion text null check (in ('anonimo','colaborador'))`
   - `modal_lectura_post_first_shown boolean not null default false`
   - `last_activity_at timestamptz not null default now()`
   - quitar datos demogrficos de usuarios annimos: ahora annimo es puro y solo colaboradore registrar ms cosas
3. En `colaboradores` aadir:
   - `ao_nacimiento smallint`
   - `city_name text`, `city_geoname_id bigint`
   - `country_name text`, `country_geoname_id bigint`
   - `relacion_obra text[]` (array de opciones en desplegable + otro libre, en el mismo array)
   - `consent_rgpd boolean not null default false`
   - `consent_rgpd_version text`, `consent_accepted_at timestamptz`
   - `updated_at timestamptz not null default now()`
4. Aadir checks e ndices para bsquedas por hash/email, geoname y modo.
5. No romper `evaluaciones` ni FKs existentes.

### Fase 2: Nuevas tablas de participacin (testimonios/documentos/vnculos)
1. Crear migracin SQL `*_02_participacion_archivo_schema.sql`.
2. Crear `testimonios` con:
   - FK a `sesiones`, FK opcional a `colaboradores`
   - `titulo text`, `testimonio text` (permite Markdown)
   - Campos contextuales, todos opcionales:
       - `experiencia_fecha date` y `experiencia_fecha_texto text` (alternativos)
       - `experiencia_ciudad_nombre text`, `experiencia_ciudad_geoname_id bigint`
       - `experiencia_pais_nombre text`, `experiencia_pais_geoname_id bigint`
       - `experiencia_lugar_texto text` (libre, para lugares no indexados en GeoNames)
       - `experiencia_contexto text` CHECK ('personal','academico','profesional','otro')
       - `experiencia_rango_edad text` CHECK ('menos_de_18','18_25','26_35','36_50','51_65','mas_de_65')
   - `relacion_obra text[]` (valores enum + texto libre del usuario en el mismo array)
   - `linked_archive_refs text[]` (enlaces o IDs de objetos del archivo)
   - `privacy_settings jsonb not null`
   - Consentimiento de envo obligatorio:
       `privacy_consent boolean not null`,
       `privacy_consent_version text not null`,
       `privacy_consent_at timestamptz not null`
   - `status text not null default 'nuevo' check (nuevo/aprobado/rechazado)`
   - `publicado boolean not null default false`
   - `archivo_objeto_id text null`
3. Crear `contribuciones_archivo` con:
   - FK a `sesiones`, FK opcional a `colaboradores`
   - Metadatos:
       `titulo text not null`
       `descripcion text`
       `creadores jsonb` (array de objetos {nombre, rol}; nmero variable)
       `fecha date` y `fecha_texto text` (alternativos, para fecha exacta o aproximada)
       `lugar_nombre text`, `lugar_geoname_id bigint` (GeoNames)
       `lugar_texto text` (libre, para lugares no indexados en GeoNames)
   - Vnculos a objetos ya existentes en el archivo:
       `linked_archive_refs text[]` (enlaces o IDs de objetos del archivo)
   - Derechos declarados sobre los archivos enviados:
       `rights_type text not null` CHECK ('cc_by_nc_sa','copyright')
       `rights_holder text` (obligatorio si rights_type = 'copyright', null si CC)
   - `drive_file_ids text[] not null` (IDs de Drive; mnimo 1 elemento al insertar)
   - `status text not null default 'nuevo'` CHECK ('nuevo','aprobado','rechazado')
   - `collectionbuilder_id text null` (se rellena manualmente al publicar en el archivo)
   - Consentimiento de envo obligatorio:
       `privacy_consent boolean not null`
       `privacy_consent_version text not null`
       `privacy_consent_at timestamptz not null`
4. Crear `vinculos_testimonio_archivo` (N:M) con unique `(testimonio_id, contribucion_id)` y `declared_from`.
5. Crear `contribuciones_upload_staging` para controlar subidas no finalizadas y limpieza.

### Fase 3: RPC v2 + RLS + hardening
1. Crear migracin SQL `*_03_rpc_v2_rls.sql` con funciones:
   - `rpc_bootstrap_session`
   - `rpc_set_mode_anonimo`
   - `rpc_collaborator_register_and_bind_session`
   - `rpc_collaborator_login_and_bind_session`
   - `rpc_submit_testimonio`
   - `rpc_submit_contribucion_archivo`
   - `rpc_link_testimonio_contribucion`
   - `rpc_list_testimonios_publicos`
2. Aadir helper de IP hash desde headers de request y tabla `participacion_rate_limit_events`.
3. Aplicar rate limits en RPC de envo (sesin + IP hash).
4. RLS:
   - tablas internas sin insert/select directo para `anon`/`authenticated`.
   - slo ejecucin de RPC.
   - exposicin pblica nicamente por vista/RPC de testimonios aprobados y publicados.
5. Mantener RPC legacy temporalmente para no romper frontend actual hasta que migre.

### Fase 4: Capa frontend compartida de sesin y modo
1. Crear capa JS compartida en `assets/js/participacion/`:
   - `session-manager.js`
   - `supabase-api-v2.js`
   - `modal-participacion.js`
   - `geonames-autocomplete.js`
2. Implementar sesin automtica al abrir web:
   - bootstrap en layouts globales (`_layouts/default.html` y `_layouts/laboratorio.html`).
   - usar `browser_session_token` persistido como cookie de sesin de navegador (no permanente).
3. Refactor de modal:
   - soportar contextos: lectura post-primera contribucin, laboratorio pre-juego, formularios pre-acceso.
   - registro/login vinculan la misma sesin existente (no crean sesin nueva).
4. Dejar `assets/js/lectura/user-manager.js` y `assets/js/lectura/modal-modo.js` como wrappers temporales para transicin controlada.

### Fase 5: Ajuste de lectura y laboratorio al nuevo flujo
1. Lectura (`assets/js/lectura/sala-de-lectura-evaluacion.js`, `assets/js/lectura/sugerencias-notas.js`):
   - permitir primera contribucion anonima sin bloquear por modal.
   - al intentar la segunda contribucion (voto o sugerencia), mostrar modal antes de enviar.
   - si cierra el modal sin elegir modo, se bloquea ese segundo envio.
   - persistencia del umbral en `localStorage` por token de sesion.
2. Laboratorio (`assets/js/lectura/laboratorio-de-notas.js`):
   - no mostrar modal al cargar pagina.
   - mostrar modal al elegir modo de juego, antes de iniciar interaccion.
3. Mi participacion sigue funcionando con estado de sesion unificado.

### Fase 6: Formularios nuevos en `/participa/*`
1. Crear pginas:
   - `pages/participa-testimonios-enviar.md` (`/participa/testimonios/enviar/`)
   - `pages/participa-documentos-enviar.md` (`/participa/documentos/enviar/`)
2. Actualizar CTAs y navegacin:
   - `pages/participa.md`
   - `_includes/navbar.html`
3. Implementar formulario Testimonios:
   - ttulo + markdown
   - campos contextuales opcionales
   - privacidad JSON
   - consentimiento obligatorio de envo
   - propuesta de aadir documento vinculado post-submit
4. Implementar formulario Aporte documental (2 pasos):
   - paso 1 metadatos/derechos
   - paso 2 subida Drive + obtencin IDs + confirmacin
   - cancelacin borra subidas (best effort inmediato + cleanup diferido garantizado)
   - propuesta de aadir testimonio vinculado post-submit
5. GeoNames obligatorio da 1 en ciudad/pas de perfil y campos de lugar contextual.

### Fase 7: Pipeline seguro de subida a Google Drive
1. Crear Edge Functions:
   - `issue-upload-token`
   - `finalize-document-upload`
   - `cancel-document-upload`
   - `cleanup-stale-uploads` (programada)
2. Apps Script:
   - endpoints `upload` y `delete` con verificacin de token firmado.
   - restricciones MIME/tamao/nmero de archivos.
3. Validar reCAPTCHA antes de emitir token de subida.
4. Registrar trazabilidad en `contribuciones_upload_staging`.

### Fase 8: Moderacin, publicacin y limpieza legacy
1. Moderacin:
   - testimonios: `status` + `publicado`
   - contribuciones: `status`
2. Crear vista pblica de testimonios para `/archivo/testimonios/` desde Supabase en vivo.
3. Limpiar/deprecar:
   - rutas/funciones legacy de sesin tras validacin completa.
   - cdigo duplicado en `assets/js/lectura/*` sustituido por capa compartida.
4. Documentar operacin:
   - gua de migraciones
   - gua de rotacin de secretos
   - gua de moderacin y flujo manual hacia CollectionBuilder.

## Casos de prueba y escenarios de validacin

1. Sesin global:
   - abrir cualquier URL del sitio crea/recupera sesin.
   - misma sesin en pestaas del mismo navegador durante la sesin activa.
2. Lectura:
   - primera contribucin annima se guarda.
   - modal aparece despus, una sola vez, y no bloquea la contribucin ya hecha.
3. Laboratorio:
   - modal aparece al elegir modo (no al cargar).
   - al registrar/login, la sesin actual se vincula sin perder historial.
4. Testimonios:
   - envo annimo y envo colaborador.
   - consentimiento de envo obligatorio.
   - privacidad JSON aplicada en salida pblica.
5. Aporte documental:
   - subida con token vlido + recaptcha.
   - cancelacin elimina archivos.
   - cierre inesperado recuperado por limpieza programada.
6. Vnculos:
   - enlace desde testimonio a documento y viceversa.
   - relacin N:M sin duplicados.
7. Seguridad:
   - sin INSERT directo por `anon` en tablas sensibles.
   - rate limit activo por sesin+IP hash.
   - slo vistas/RPC pblicos exponen datos publicados.
8. Regresin:
   - `/lectura/` sigue leyendo XML esttico si Supabase falla.
   - `/participa/laboratorio/` sigue operativo con Supabase disponible.
9. Migraciones:
   - `supabase db reset` local limpio.
   - `supabase db pull` sin error de shadow database.
   - `supabase migration up` idempotente en entorno de staging.

## Supuestos y defaults explcitos
- Modelo nico de sesin: una sesin por navegador activo, no por pgina.
- `status` estndar para envos: `nuevo`, `aprobado`, `rechazado`.
- Testimonios visibles slo con `status='aprobado'` y `publicado=true`.
- Consentimientos separados:
  - consentimiento de perfil en `colaboradores` (cuando hay registro).
  - consentimiento por envo en cada formulario.
- GeoNames obligatorio desde el primer release funcional.
- Se mantiene Drive como almacenamiento binario; Supabase slo guarda metadatos e IDs.
- Lmite inicial recomendado de abuso:
  - testimonios: 3/24h por sesin, 10/24h por IP hash.
  - contribuciones: 2/24h por sesin, 8/24h por IP hash.
- No se elimina RPC legacy hasta cerrar validacin funcional y de datos en produccin.

## Backlog de refactor tecnico

| id | area | deuda | impacto | riesgo | fase objetivo | estado | criterio de cierre |
| --- | --- | --- | --- | --- | --- | --- | --- |
| RF-001 | JS arquitectura | Migrar de IIFE global a ES Modules cuando se retire `legacy-bridge.js`. | Alto | Medio | Fase 8 | pendiente | Los scripts de participacion se cargan como modulos sin `window.*` compartido. |
| RF-002 | JS legacy | Eliminar `assets/js/lectura/user-manager.js` y `assets/js/lectura/modal-modo.js` (shims). | Medio | Bajo | Fase 8 | completado | Archivos legacy eliminados y sin referencias en runtime activo. |
| RF-003 | UI modal | Separar plantilla HTML del modal en parcial/template y dejar JS solo con logica. | Medio | Bajo | Fase 6 | pendiente | El render del modal no contiene HTML inline largo en JS. |
| RF-004 | Manejo errores | Unificar toasts/errores de RPC con codigos normalizados por capa. | Alto | Medio | Fase 9.4 | completado | Errores de participacion muestran mensajes consistentes por codigo. |
| RF-005 | QA automatizada | Anadir pruebas automatizadas para bootstrap, bind de sesion y reset a `unasked`. | Alto | Medio | Fase 7 | en progreso | Flujo session/mode/bind cubierto en test automatizado reproducible. |
| RF-006 | Configuracion | Consolidar configuracion Supabase en unica fuente y retirar fallback legacy duplicado. | Medio | Bajo | Fase 8 | completado | Fuente unica activa: `window.__SUPABASE_CONFIG__ -> window.Participacion.config`, sin alias legacy. |
| RF-015 | UX + consistencia | Sincronizar umbral de segunda contribucion de lectura en backend (sin depender solo de localStorage). | Alto | Medio | Fase 8 | pendiente | El umbral se valida tambien en backend y no se reinicia solo por limpiar storage. |
| RF-016 | Observabilidad | Instrumentar telemetria del embudo de lectura (1ra contribucion, apertura modal 2da, eleccion, abandono). | Medio | Bajo | Fase 10.2 | completado | Eventos de embudo registrados por sesion con dedupe en DB y consulta operativa documentada. |
| RF-017 | Accesibilidad UX | Reemplazar alert/confirm nativos por modales accesibles y toasts unificados. | Medio | Bajo | Fase 9.2 | completado | No quedan alert/confirm en flujos de participacion. |
| RF-018 | Robustez frontend | Anadir guardas anti doble submit y condiciones de carrera en umbral de 2da contribucion. | Alto | Medio | Fase 9.3 | completado | No hay doble envio por clicks repetidos o latencia. |
| RF-019 | QA e2e | Crear pruebas end-to-end del flujo primera libre / segunda bloqueada / seleccion de modo. | Alto | Medio | Fase 7 | en progreso | Suite automatizada cubre lectura y no hay regresiones de gateo. |
| RF-020 | Seguridad abuso | Aplicar rate limit explicito a rpc_submit_participation_event (sesion + IP hash). | Alto | Medio | Fase 8.3 | completado | Rate limit anti-flood activo en evaluaciones (12/min sesion, 60/min IP) con mensaje UI explicito. |
| RF-021 | Encoding | Corregir mojibake heredado en contenido web (templates, paginas y copys JS) y fijar politica UTF-8 end-to-end. | Alto | Medio | Fase 9.1 | completado | JS de lectura/laboratorio/participacion saneado en UI publica y sin textos corruptos en flujos principales. |
| RF-022 | Config frontend | Inyectar `GEONAMES_USERNAME` y `RECAPTCHA_SITE_KEY` en runtime sin hardcode, con fuente unica documentada. | Alto | Medio | Fase 7 | completado | Runtime publico unificado en `window.__SUPABASE_CONFIG__` y consumidores modernos. |
| RF-023 | Upload pipeline | Sustituir fallback manual de IDs de Drive por subida segura completa (token + finalize/cancel + cleanup). | Alto | Medio | Fase 7 | en progreso | DB + edge + formulario staged activos; falta cerrar QA automatizada y despliegue Apps Script productivo. |
| RF-024 | Upload UX | Permitir borrado individual/reintento de archivo dentro de un staging sin cancelar lote completo. | Medio | Bajo | Fase 8 | pendiente | El usuario puede gestionar archivos uno a uno antes del envio final sin perder el resto. |
| RF-025 | Operacion cleanup | Anadir alertas operativas para `cleanup_failed` y tendencia de huerfanos en staging. | Medio | Bajo | Fase 8 | pendiente | Existen alertas y metricas periodicas para detectar fallos de limpieza rapidamente. |



